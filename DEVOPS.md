# Инструкция по развертывания инфраструктуры проекта

## Что автоматизировано

### Yandex Cloud

- Создание сервисного аккуанта с минимальными правами.
- Саздание бакета без публичного доступа.
- ToDo. Создание контейнеров.

### Render

- Создание проекта и его окружений (enviroments).
- Создание сервиса и всех его переменных окружения.
- Создание кастомного домена для каждого сервиса.
- ToDo. Создание репо в GitHub.
- Привязывание сервиса к ветке GitHub.

### Cloudflare

- Создание dns-записей для кастомных доменов.
- ToDo. Создание тунеля в Yandex Cloud.
- ToDo. Создание dns-записей для контейнеров Yandex Cloud.

### Onedev

- ToDo. Настройка синхронизации с GitHub.

## Переменные окружения

Разбиты на 2 группы:

- `.env`. Для доступа к провайдерам инфраструктуры - Yandex Cloud, Render, Cloudflare.
- `devops/env.ts`. Для настройки самого приложения и его развертывания в инфраструктуре.

Оба файла не комитятся в гит, нужно создавать руками. Для удобства есть примеры.

## Развертывание

Всем этим хозайством управляет [SST](https://sst.dev/), который базируется на [Pulumi](https://www.pulumi.com/) и [Terraform](https://developer.hashicorp.com/terraform).
Развертывание делится на стадии/окружения:

- `init` - специальная стадия для первичной подготовки.
- `dev` - разработка.
- `test` - тестирование.
- `prod` - продакшен.

Состояние стадий помнит Cloudflare R2, т.е. в зашифрованном файле в их облаке. Это означает, что SST сам понимает, что уже было развернуто, а что нет, были изменения или нет.

### Первичное развертывание

Для первичного развертывания должны быть подготовлены `.env` и `devops/env.ts`. Пошагово:

- Берем секретные секреты у товарища, что их значет.
- Создаем `.env` по образцу `.env.example`.
- Создаем `devops/env.ts` по образцу `devops/env.example.ts`.
- Устанавливаем SST, если еще не зупаскали - `bun install`.
- Деплоим - `bun run devops init`.

### Развертывание окружений

Просто запускаем `bun run devops {название окружения}`

### Удаление окружений

Запускаем SST напрямую `bun sst remove --stage {название окружения}`. Если нужно удалить все, то удаляем и `init`, но после удаления всех окружений. Конечно, удалиться все на свете - БД, бакет с файлами и т.д.

## Разработка

Запускаем обычный `bun dev`. Он запустит консоль разработки SST. SST передаст все переменные в локальное окружение и сам запустит `vite dev`. В консоле нужно выбирать `Dev server`, чтобы смотреть ошибки, логи. Выход через `Ctrl+C`. Dev-сервер можно останавливать через `x` и запускать через `Enter`.
